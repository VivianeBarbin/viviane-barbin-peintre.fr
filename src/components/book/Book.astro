---
/**
 * Book.astro
 *
 * Section component for the `/mon-livre` index page.
 * Renders a section title, subtitle, and an interactive PDF slider.
 *
 * At build time, the PDF is pre-rendered to WebP images for instant loading.
 */
import { Icon } from "astro-icon/components";
import PdfSlider from "@/components/book/PdfSlider.astro";
import { PortableText } from "astro-portabletext";
import { fetchSanity } from "@/lib/sanityFetch";
import { BOOK_CONTENT_QUERY } from "@/lib/sanityQueries";
import { renderPdfToImages } from "@/utils/pdfRenderer";

interface Props {
  /** Section heading (e.g. "Mon Livre") */
  title?: string;
}

interface BookData {
  subtitle?: string;
  pdfUrl?: string;
  content?: any[];
}

const { title = "Livre de Viviane" } = Astro.props;

// Fetch book data from Sanity
const bookData = await fetchSanity<BookData>(BOOK_CONTENT_QUERY);

// Debug logging for production issues
console.log("[Book] Dataset:", import.meta.env.SANITY_DATASET || "local_dev");
console.log("[Book] Book data received:", bookData ? "YES" : "NO");
if (bookData) {
  console.log("[Book] Has subtitle:", !!bookData.subtitle);
  console.log("[Book] Has pdfUrl:", !!bookData.pdfUrl);
  console.log(
    "[Book] Has content:",
    Array.isArray(bookData.content) && bookData.content.length > 0
  );
}

const hasData = bookData !== null && bookData !== undefined;
const subtitle = bookData?.subtitle ?? "Les mots qui racontent mes toiles";
const content = bookData?.content ?? [];
const pdfUrl = bookData?.pdfUrl ?? "";

// Pre-render PDF pages to WebP images at build time
let pdfPages: string[] = [];
let pdfWidth = 0;
let pdfHeight = 0;

if (pdfUrl) {
  try {
    const result = await renderPdfToImages(pdfUrl, {
      width: 1200,
      quality: 80,
    });
    pdfPages = result.pageUrls;
    pdfWidth = result.width;
    pdfHeight = result.height;
    console.log(`[Book] PDF rendered: ${result.totalPages} pages`);
  } catch (error) {
    console.error("[Book] Failed to render PDF:", error);
  }
}
---

{
  hasData ? (
    <>
      <section class="book-section bg-background text-primary">
        <div class="site-container">
          <div class="my-10 flex flex-col gap-y-[1.875rem]">
            <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
              <span class="inline-flex self-center">
                <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
              </span>
              {title}
            </h1>

            {subtitle && (
              <h2 class="m-0 max-w-[36ch] text-[1.75rem] font-light leading-[1.3] md:text-[2.25rem]">
                {subtitle}
              </h2>
            )}
          </div>

          {content && content.length > 0 && (
            <div class="prose prose-lg max-w-none mb-12">
              <PortableText value={content} />
            </div>
          )}
        </div>
      </section>

      <section class="pdf-section bg-backgroundAccent text-primary">
        <div class="site-container">
          {pdfPages.length > 0 ? (
            <PdfSlider pages={pdfPages} width={pdfWidth} height={pdfHeight} />
          ) : (
            <p class="py-12 text-center opacity-60">
              Le livre n'est pas disponible pour le moment.
            </p>
          )}
        </div>
      </section>
    </>
  ) : (
    <section class="book-section bg-background text-primary">
      <div class="site-container">
        <div class="my-10 flex flex-col gap-y-[1.875rem]">
          <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
            <span class="inline-flex self-center">
              <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
            </span>
            {title}
          </h1>
        </div>
        <div class="py-12">
          <p class="text-muted text-center">
            Contenu non disponible. Veuillez vérifier que le document "Mon livre" est publié dans
            Sanity Studio (dataset: {import.meta.env.SANITY_DATASET || "local_dev"}).
          </p>
        </div>
      </div>
    </section>
  )
}
