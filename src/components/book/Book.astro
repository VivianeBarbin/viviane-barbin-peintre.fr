---
/**
 * Book.astro
 *
 * Section component for the `/mon-livre` index page.
 * Renders a section title, subtitle, and an interactive PDF slider.
 *
 * PDF pages are pre-rendered at build time by scripts/render-pdf-pages.ts
 * This component reads the pre-generated images from public/pdf-pages/
 */
import { Icon } from "astro-icon/components";
import Button from "@/components/button/Button.astro";
import PdfSlider from "@/components/book/PdfSlider.astro";
import RichText from "@/components/portable-text/RichText.astro";

import { fetchSanity } from "@/lib/sanityFetch";
import { BOOK_CONTENT_QUERY } from "@/lib/sanityQueries";

// ── PDF pages — resolved statically at build time by Vite ────────────────────
// The render-pdf-pages.ts prebuild script writes files to public/pdf-pages/.
// import.meta.glob runs at build time (no Node.js APIs needed at runtime),
// which makes this compatible with the Cloudflare Workers runtime.
const pdfPageModules = import.meta.glob<string>("/public/pdf-pages/*.webp", {
  eager: true,
  query: "?url",
  import: "default",
});

interface Props {
  /** Section heading (e.g. "Mon Livre") */
  title?: string;
}

interface BookData {
  subtitle?: string;
  pdfUrl?: string;
  content?: any[];
  resellerLink?: {
    label: string;
    url: string;
    openInNewTab: boolean;
  };
}

const { title = "Livre de Viviane" } = Astro.props;

// Fetch book data from Sanity
const bookData = await fetchSanity<BookData>(BOOK_CONTENT_QUERY);

const hasData = bookData !== null && bookData !== undefined;
const subtitle = bookData?.subtitle ?? "Les mots qui racontent mes toiles";
const content = bookData?.content ?? [];
const resellerLink = bookData?.resellerLink ?? {
  label: "Acheter le livre",
  url: "#",
  openInNewTab: true,
};

// ── PDF page list — sorted by page number ────────────────────────────────────
// Dimensions are fixed constants matching the render-pdf-pages.ts output
// (width: 1800, A4 ratio 1:√2). No runtime file I/O needed.
const PDF_WIDTH = 1800;
const PDF_HEIGHT = Math.round(PDF_WIDTH * 1.4142);

const pdfPages: string[] = Object.keys(pdfPageModules)
  .sort((a, b) => {
    const numA = parseInt(a.match(/-(\d+)\.webp$/)?.[1] ?? "0");
    const numB = parseInt(b.match(/-(\d+)\.webp$/)?.[1] ?? "0");
    return numA - numB;
  })
  // Strip the /public prefix — files in public/ are served from the root
  .map((path) => path.replace(/^\/public/, ""));

const pdfWidth = PDF_WIDTH;
const pdfHeight = PDF_HEIGHT;
---

{
  hasData ? (
    <>
      <section class="book-section bg-background text-primary pt-8 pb-16">
        <div class="site-container">
          <div class="my-10 flex flex-col gap-y-[1.875rem]">
            <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
              <span class="inline-flex self-center">
                <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
              </span>
              {title}
            </h1>

            {subtitle && (
              <h2 class="m-0 max-w-[36ch] text-[1.75rem] font-light leading-[1.3] md:text-[2.25rem]">
                {subtitle}
              </h2>
            )}
          </div>

          {content && content.length > 0 && (
            <div class="mb-12">
              <RichText value={content} />
            </div>
          )}
        </div>
      </section>

      <section class="pdf-section bg-backgroundAccent text-primary  pb-4">
        <div class="site-container">
          {pdfPages.length > 0 ? (
            <PdfSlider pages={pdfPages} width={pdfWidth} height={pdfHeight} />
          ) : (
            <div class="py-12">
              <p class="text-center opacity-60 mb-4">
                Les pages du livre n'ont pas encore été générées.
              </p>
            </div>
          )}
          {resellerLink?.url && (
            <div class="py-12 flex justify-end">
              <Button
                variant="secondary"
                size="sm"
                class="w-full md:w-auto !hover:text-primaryForeground/80 !hover:border-primaryForeground/60"
                href={resellerLink.url}
                target={resellerLink.openInNewTab ? "_blank" : "_self"}
              >
                {resellerLink.label}
              </Button>
            </div>
          )}
        </div>
      </section>
    </>
  ) : (
    <section class="book-section bg-background text-primary">
      <div class="site-container">
        <div class="my-10 flex flex-col gap-y-[1.875rem]">
          <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
            <span class="inline-flex self-center">
              <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
            </span>
            {title}
          </h1>
        </div>
        <div class="py-12">
          <p class="text-muted text-center">
            Contenu non disponible. Veuillez vérifier que le document "Mon livre" est publié dans
            Sanity Studio (dataset: {import.meta.env.SANITY_DATASET || "production"}).
          </p>
        </div>
      </div>
    </section>
  )
}
