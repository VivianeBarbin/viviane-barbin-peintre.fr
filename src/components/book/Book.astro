---
/**
 * Book.astro
 */

import { Icon } from "astro-icon/components";
import PdfSlider from "@/components/book/PdfSlider.astro";
import { PortableText } from "astro-portabletext";
import { fetchSanity } from "@/lib/sanityFetch";
import { BOOK_CONTENT_QUERY } from "@/lib/sanityQueries";
import { renderPdfToImages } from "@/utils/pdfRenderer";

interface Props {
  title?: string;
}

const { title = "Livre de Viviane" } = Astro.props;

const bookData = await fetchSanity<Record<string, any>>(BOOK_CONTENT_QUERY);

const hasData = bookData !== null;
const subtitle = bookData?.subtitle ?? "Les mots qui racontent mes toiles";
const content = bookData?.content ?? [];
const pdfUrl = bookData?.pdfUrl ?? "";

let pdfPages: string[] = [];
let pdfWidth = 0;
let pdfHeight = 0;

if (pdfUrl) {
  try {
    const result = await renderPdfToImages(pdfUrl, {
      width: 1200,
      quality: 80,
    });

    pdfPages = result.pageUrls;
    pdfWidth = result.width;
    pdfHeight = result.height;

    console.log(`[Book] PDF rendered: ${result.totalPages} pages`);
  } catch (error) {
    console.error("[Book] Failed to render PDF:", error);
  }
}
---

{
  hasData ? (
    <>
      <section class="book-section bg-background text-primary">
        <div class="site-container">
          <div class="my-10 flex flex-col gap-y-[1.875rem]">
            <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
              <span class="inline-flex self-center">
                <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
              </span>
              {title}
            </h1>

            {subtitle && (
              <h2 class="m-0 max-w-[36ch] text-[1.75rem] font-light leading-[1.3] md:text-[2.25rem]">
                {subtitle}
              </h2>
            )}
          </div>

          {content.length > 0 && (
            <div class="prose">
              <PortableText value={content} />
            </div>
          )}
        </div>
      </section>

      <section class="pdf-section bg-backgroundAccent text-primary">
        <div class="site-container">
          {pdfPages.length > 0 ? (
            <PdfSlider pages={pdfPages} width={pdfWidth} height={pdfHeight} />
          ) : (
            <p class="py-12 text-center opacity-60">
              Le livre n'est pas disponible pour le moment.
            </p>
          )}
        </div>
      </section>
    </>
  ) : (
    <section class="homepage-about bg-backgroundAccent">
      <div class="site-container">
        <p class="text-muted">
          Contenu "Mon livre" non disponible. Veuillez cr√©er un document dans Sanity Studio.
        </p>
      </div>
    </section>
  )
}
