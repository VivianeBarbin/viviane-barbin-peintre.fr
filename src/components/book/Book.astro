---
/**
 * Book.astro
 *
 * Section component for the `/mon-livre` index page.
 * Renders a section title, subtitle, and an interactive PDF slider.
 *
 * PDF pages are pre-rendered at build time by scripts/render-pdf-pages.ts
 * This component reads the pre-generated images from public/pdf-pages/
 */
import { Icon } from "astro-icon/components";
import Button from "@/components/button/Button.astro";
import PdfSlider from "@/components/book/PdfSlider.astro";
import RichText from "@/components/portable-text/RichText.astro";

import { fetchSanity } from "@/lib/sanityFetch";
import { BOOK_CONTENT_QUERY } from "@/lib/sanityQueries";
import { existsSync } from "node:fs";
import { readdir } from "node:fs/promises";
import { join } from "node:path";
import sharp from "sharp";

interface Props {
  /** Section heading (e.g. "Mon Livre") */
  title?: string;
}

interface BookData {
  subtitle?: string;
  pdfUrl?: string;
  content?: any[];
  resellerLink?: {
    label: string;
    url: string;
    openInNewTab: boolean;
  };
}

const { title = "Livre de Viviane" } = Astro.props;

// Fetch book data from Sanity
const bookData = await fetchSanity<BookData>(BOOK_CONTENT_QUERY);

const hasData = bookData !== null && bookData !== undefined;
const subtitle = bookData?.subtitle ?? "Les mots qui racontent mes toiles";
const content = bookData?.content ?? [];
const resellerLink = bookData?.resellerLink ?? {
  label: "Acheter le livre",
  url: "#",
  openInNewTab: true,
};

// Read pre-rendered PDF pages from public/pdf-pages/
let pdfPages: string[] = [];
let pdfWidth = 0;
let pdfHeight = 0;

try {
  const pdfPagesDir = join(process.cwd(), "public/pdf-pages");

  if (existsSync(pdfPagesDir)) {
    const files = await readdir(pdfPagesDir);
    const webpFiles = files
      .filter((f) => f.endsWith(".webp"))
      .sort((a, b) => {
        const numA = parseInt(a.match(/-(\d+)\.webp$/)?.[1] || "0");
        const numB = parseInt(b.match(/-(\d+)\.webp$/)?.[1] || "0");
        return numA - numB;
      });

    if (webpFiles.length > 0) {
      pdfPages = webpFiles.map((f) => `/pdf-pages/${f}`);

      // Get dimensions from first image
      const firstImagePath = join(pdfPagesDir, webpFiles[0]);
      const metadata = await sharp(firstImagePath).metadata();
      pdfWidth = metadata.width || 1200;
      pdfHeight = metadata.height || Math.round(pdfWidth * 1.414);

      console.log(`[Book] Loaded ${pdfPages.length} pre-rendered PDF pages`);
    }
  } else {
    console.warn("[Book] No PDF pages directory found. Run: pnpm tsx scripts/render-pdf-pages.ts");
  }
} catch (error) {
  console.error("[Book] Failed to read pre-rendered PDF pages:", error);
}
---

{
  hasData ? (
    <>
      <section class="book-section bg-background text-primary pt-8 pb-16">
        <div class="site-container">
          <div class="my-10 flex flex-col gap-y-[1.875rem]">
            <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
              <span class="inline-flex self-center">
                <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
              </span>
              {title}
            </h1>

            {subtitle && (
              <h2 class="m-0 max-w-[36ch] text-[1.75rem] font-light leading-[1.3] md:text-[2.25rem]">
                {subtitle}
              </h2>
            )}
          </div>

          {content && content.length > 0 && (
            <div class="mb-12">
              <RichText value={content} />
            </div>
          )}
        </div>
      </section>

      <section class="pdf-section bg-backgroundAccent text-primary  pb-4">
        <div class="site-container">
          {pdfPages.length > 0 ? (
            <PdfSlider pages={pdfPages} width={pdfWidth} height={pdfHeight} />
          ) : (
            <div class="py-12">
              <p class="text-center opacity-60 mb-4">
                Les pages du livre n'ont pas encore été générées.
              </p>
            </div>
          )}
          {resellerLink?.url && (
            <div class="py-12 flex justify-end">
              <Button
                variant="secondary"
                size="sm"
                class="w-full md:w-auto !hover:text-primaryForeground/80 !hover:border-primaryForeground/60"
                href={resellerLink.url}
                target={resellerLink.openInNewTab ? "_blank" : "_self"}
              >
                {resellerLink.label}
              </Button>
            </div>
          )}
        </div>
      </section>
    </>
  ) : (
    <section class="book-section bg-background text-primary">
      <div class="site-container">
        <div class="my-10 flex flex-col gap-y-[1.875rem]">
          <h1 class="flex items-baseline gap-x-2 text-sm uppercase tracking-wider">
            <span class="inline-flex self-center">
              <Icon name="tabler/square" class="size-3.5 translate-y-1px" aria-hidden="true" />
            </span>
            {title}
          </h1>
        </div>
        <div class="py-12">
          <p class="text-muted text-center">
            Contenu non disponible. Veuillez vérifier que le document "Mon livre" est publié dans
            Sanity Studio (dataset: {import.meta.env.SANITY_DATASET || "production"}).
          </p>
        </div>
      </div>
    </section>
  )
}
