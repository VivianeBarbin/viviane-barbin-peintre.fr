---
import { Image } from "astro:assets";
import Button from "@/components/button/Button.astro";
import { resolveImageWithFallback } from "@/utils/imageUtils";
import { buildSanityDprSrcSet, buildSanityImageUrl } from "@/utils/sanityImage";
import { getContactData } from "@config/contact";
import { getSiteSettings, themeConfig } from "@config/site";
import { navigationLinks } from "@config/navigation";
import { fetchSanity } from "@/lib/sanityFetch";
import { HOME_CONTENT_QUERY } from "@/lib/sanityQueries";

// Fetch home content from Sanity (via shared fetch helper + named query)
const homeData = await fetchSanity<Record<string, any>>(HOME_CONTENT_QUERY);

// Resolve settings singletons (Sanity + fallback)
const contactData = await getContactData();
const siteSettings = await getSiteSettings();
const galerieLink = navigationLinks.find((nav) => nav.link === "/galeries");

// Local fallback image paths
const ATELIER_IMAGE_PATH = "@images/homepage/homepage-placeholder_01.jpg";
const PAINTING_IMAGE_PATH = "@images/homepage/homepage-placeholder_02.jpg";
const FALLBACK_IMAGE_PATH = "@images/homepage/homepage-placeholder_01.jpg";

// --- Atelier Image handling: Sanity optimized with local fallback ---
// NOTE: mapping fix — the document fields were used inverted in the layout.
// The "atelier" card must render the image stored in `paintingImage`.
const sanityAtelierSource = homeData?.paintingImage ?? null;
const sanityAtelierAlt =
  homeData?.paintingImage?.alt ??
  "L'atelier de Viviane Barbin, un espace de création baigné de lumière naturelle";

// Target display size for atelier image (CSS pixels)
const atelierWidth = 702;
const atelierHeight = 468;

const sanitySrcAtelier = buildSanityImageUrl({
  source: sanityAtelierSource,
  width: atelierWidth,
  height: atelierHeight,
  quality: 80,
  format: "webp",
  fit: "crop",
});

const sanitySrcSetAtelier = buildSanityDprSrcSet({
  source: sanityAtelierSource,
  width: atelierWidth,
  height: atelierHeight,
  dprs: [1, 1.5, 2],
  quality: 80,
  format: "webp",
  fit: "crop",
});

const shouldRenderSanityAtelierImage = !!sanitySrcAtelier;

// Local fallback for atelier image
const atelierImage = resolveImageWithFallback(ATELIER_IMAGE_PATH, FALLBACK_IMAGE_PATH);
const shouldRenderAtelierFallback = !shouldRenderSanityAtelierImage && atelierImage !== null;
const hasAtelierImage = shouldRenderSanityAtelierImage || shouldRenderAtelierFallback;

// --- Painting Image handling: Sanity optimized with local fallback ---
// NOTE: mapping fix — the "painting" card must render the image stored in `atelierImage`.
const sanityPaintingSource = homeData?.atelierImage ?? null;
const sanityPaintingAlt =
  homeData?.atelierImage?.alt ??
  "Peinture de paysage forestier avec rivière, œuvre de Viviane Barbin";

// Target display size for painting image (CSS pixels)
const paintingWidth = 702;
const paintingHeight = 936;

const sanitySrcPainting = buildSanityImageUrl({
  source: sanityPaintingSource,
  width: paintingWidth,
  height: paintingHeight,
  quality: 80,
  format: "webp",
  fit: "crop",
});

const sanitySrcSetPainting = buildSanityDprSrcSet({
  source: sanityPaintingSource,
  width: paintingWidth,
  height: paintingHeight,
  dprs: [1, 1.5, 2],
  quality: 80,
  format: "webp",
  fit: "crop",
});

const shouldRenderSanityPaintingImage = !!sanitySrcPainting;

// Local fallback for painting image
const paintingImage = resolveImageWithFallback(PAINTING_IMAGE_PATH, FALLBACK_IMAGE_PATH);
const shouldRenderPaintingFallback = !shouldRenderSanityPaintingImage && paintingImage !== null;
const hasPaintingImage = shouldRenderSanityPaintingImage || shouldRenderPaintingFallback;
---

<section class="homepage-features pt-8 pb-4">
  <div class="site-container">
    <div class="features-grid">
      {/* Feature Card 1 - Text Content */}
      <article class="feature-card-1">
        <div class="grid h-auto w-full grid-cols-1 gap-4 lg:h-full lg:grid-cols-2">
          <address class="hidden h-full flex-col justify-end not-italic lg:flex">
            <span>
              {contactData.address.city} ({contactData.address.region}),
              {contactData.address.country}
            </span>
            <br />
            <a href={`mailto:${contactData.email}`} class="">
              {contactData.email}
            </a>
          </address>
          <div class="flex h-auto flex-col lg:col-span-1 lg:h-full lg:justify-center">
            <h1 class="heading-home">
              {siteSettings.subtitle}
            </h1>
          </div>
        </div>
      </article>

      {/* Feature Card 2 - Atelier Image */}
      <article class="feature-card-2">
        {
          hasAtelierImage ? (
            <div class="relative h-full w-full">
              {shouldRenderSanityAtelierImage ? (
                <img
                  src={sanitySrcAtelier}
                  srcset={sanitySrcSetAtelier ?? undefined}
                  sizes={`(max-width: 768px) 100vw, ${atelierWidth}px`}
                  width={atelierWidth}
                  height={atelierHeight}
                  alt={sanityAtelierAlt}
                  class="feature-image"
                  loading="lazy"
                  decoding="async"
                />
              ) : shouldRenderAtelierFallback ? (
                <Image
                  src={atelierImage}
                  alt={sanityAtelierAlt}
                  class="feature-image"
                  widths={[320, 480, 702, 800]}
                  sizes="(max-width: 768px) 100vw, 702px"
                  loading="lazy"
                  decoding="async"
                />
              ) : null}
              <div class="from-background via-background/10 absolute inset-0 bg-linear-to-t to-transparent" />
              <div class="absolute inset-0 flex items-end p-4 pb-10 md:p-6">
                <Button variant="secondary" size="sm" class="w-full md:w-auto">
                  <a href={galerieLink?.link ?? "/galeries"}>
                    {galerieLink?.button ?? "Parcourir mes créations"}
                  </a>
                </Button>
              </div>
            </div>
          ) : (
            <div class="feature-image-placeholder" aria-hidden="true">
              <span>Image non disponible</span>
            </div>
          )
        }
      </article>

      {/* Feature Card 3 - Painting Image (spans 2 rows) */}
      <article class="feature-card-3">
        {
          hasPaintingImage ? (
            <div class="relative h-full w-full">
              {shouldRenderSanityPaintingImage ? (
                <img
                  src={sanitySrcPainting}
                  srcset={sanitySrcSetPainting ?? undefined}
                  sizes={`(max-width: 768px) 100vw, ${paintingWidth}px`}
                  width={paintingWidth}
                  height={paintingHeight}
                  alt={sanityPaintingAlt}
                  class="feature-image"
                  loading="lazy"
                  decoding="async"
                />
              ) : shouldRenderPaintingFallback ? (
                <Image
                  src={paintingImage}
                  alt={sanityPaintingAlt}
                  class="feature-image"
                  widths={[320, 480, 702, 800]}
                  sizes="(max-width: 768px) 100vw, 702px"
                  loading="lazy"
                  decoding="async"
                />
              ) : null}
              <div class="from-background via-background/10 absolute inset-0 bg-linear-to-t to-transparent" />
              <div class="absolute inset-0 flex items-end p-6">
                <Button variant="secondary" size="sm" class="w-full md:w-auto">
                  Découvrir l'atelier
                </Button>
              </div>
            </div>
          ) : (
            <div class="feature-image-placeholder" aria-hidden="true">
              <span>Image non disponible</span>
            </div>
          )
        }
      </article>
    </div>
  </div>

  <style>
    .features-grid {
      @apply grid gap-4 py-10 grid-cols-1 grid-rows-[auto_1fr_1fr] min-h-100lvh md:grid-cols-2
        md:grid-rows-[auto_1fr] md:max-h-[calc(100dvh-var(--navbar-height, 90px))] md:min-h-0
        md:box-border lg:gap-10 lg:grid-rows-2
        lg:max-h-[calc(100dvh-var(--navbar-height, 90px))] lg:min-h-0 lg:box-border;
    }

    .feature-card-1 {
      /* mobile → md:pleine largeur en haut → lg:en haut à gauche */
      @apply grid-area-[1/1/2/2] md:grid-area-[1/1/2/3] lg:grid-area-[1/1/2/2];
    }

    .feature-card-2 {
      /* mobile → md:bas gauche → lg:bas gauche */
      @apply grid-area-[2/1/3/2] md:grid-area-[2/1/3/2] lg:grid-area-[2/1/3/2];
    }

    .feature-card-3 {
      /* mobile → md:bas droite → lg:span 2 rows à droite */
      @apply grid-area-[3/1/4/2] md:grid-area-[2/2/3/3] lg:grid-area-[1/2/3/3];
    }

    .feature-card-1,
    .feature-card-2,
    .feature-card-3 {
      @apply flex flex-col overflow-hidden;
    }

    .feature-card-1 {
      @apply justify-center items-start;
    }

    .feature-card-2,
    .feature-card-3 {
      @apply relative;
    }

    .feature-image {
      @apply h-full w-full object-cover transition-transform duration-500;
    }

    .feature-card-2:hover .feature-image,
    .feature-card-3:hover .feature-image {
      @apply scale-105;
    }

    .feature-image-placeholder {
      @apply flex h-full min-h-48 items-center justify-center rounded-lg bg-muted
        text-mutedForeground;
    }

    .heading-home {
      white-space: pre-line;
      @media (768px <= width <= 1023px) {
        white-space: normal;
      }
      /*@apply whitespace-normal lg:whitespace-pre-line;*/
    }
  </style>
</section>
