---
import { Image } from "astro:assets";
import Button from "@/components/button/Button.astro";
import { resolveImageWithFallback } from "@/utils/imageUtils";
import { contactData } from "@config/contact";
import { themeConfig } from "@config/site";

// Image paths using the @images alias
const ATELIER_IMAGE_PATH = "@images/homepage/homepage-placeholder_01.jpg";
const PAINTING_IMAGE_PATH = "@images/homepage/homepage-placeholder_02.jpg";
const FALLBACK_IMAGE_PATH = "@images/homepage/homepage-placeholder_01.jpg";

// Resolve images with fallback - support and caching (handled by imageUtils)
const atelierImage = resolveImageWithFallback(ATELIER_IMAGE_PATH, FALLBACK_IMAGE_PATH);
const paintingImage = resolveImageWithFallback(PAINTING_IMAGE_PATH, FALLBACK_IMAGE_PATH);

// Check if images loaded successfully
const hasAtelierImage = atelierImage !== null;
const hasPaintingImage = paintingImage !== null;
---

<section class="homepage-features">
  <div class="site-container">
    <div class="features-grid">
      {/* Feature Card 1 - Text Content */}
      <article class="feature-card-1">
        <div class="grid h-auto w-full grid-cols-1 gap-4 lg:h-full lg:grid-cols-2">
          <address class="hidden h-full flex-col justify-end not-italic lg:flex">
            <span>
              {contactData.address.city} ({contactData.address.region}),
              {contactData.address.country}
            </span>
            <br />
            <a href={`mailto:${contactData.email}`} class="">
              {contactData.email}
            </a>
          </address>
          <div class="flex h-auto flex-col lg:col-span-1 lg:h-full lg:justify-center">
            <h1 class="heading-home">
              {themeConfig.site.subtitle}
            </h1>
          </div>
        </div>
      </article>

      {/* Feature Card 2 - Atelier Image */}
      <article class="feature-card-2">
        {
          hasAtelierImage ? (
            <div class="relative h-full w-full">
              <Image
                src={atelierImage}
                alt="L'atelier de Viviane Barbin, un espace de création baigné de lumière naturelle"
                class="feature-image"
                widths={[320, 480, 702, 800]}
                sizes="(max-width: 768px) 100vw, 702px"
                loading="lazy"
                decoding="async"
              />
              <div class="from-background via-background/10 absolute inset-0 bg-linear-to-t to-transparent" />
              <div class="absolute inset-0 flex items-end p-4 pb-10 md:p-6">
                <Button variant="secondary" size="sm" class="w-full md:w-auto">
                  Parcourir mes créations
                </Button>
              </div>
            </div>
          ) : (
            <div class="feature-image-placeholder" aria-hidden="true">
              <span>Image non disponible</span>
            </div>
          )
        }
      </article>

      {/* Feature Card 3 - Painting Image (spans 2 rows) */}
      <article class="feature-card-3">
        {
          hasPaintingImage ? (
            <div class="relative h-full w-full">
              <Image
                src={paintingImage}
                alt="Peinture de paysage forestier avec rivière, œuvre de Viviane Barbin"
                class="feature-image"
                widths={[320, 480, 702, 800]}
                sizes="(max-width: 768px) 100vw, 702px"
                loading="lazy"
                decoding="async"
              />
              <div class="from-background via-background/10 absolute inset-0 bg-linear-to-t to-transparent" />
              <div class="absolute inset-0 flex items-end p-6">
                <Button variant="secondary" size="sm" class="w-full md:w-auto">
                  Découvrir l'atelier
                </Button>
              </div>
            </div>
          ) : (
            <div class="feature-image-placeholder" aria-hidden="true">
              <span>Image non disponible</span>
            </div>
          )
        }
      </article>
    </div>
  </div>

  <style>
    .features-grid {
      --at-apply: grid gap-4 py-10 grid-cols-1 grid-rows-[auto_1fr_1fr] min-h-100lvh md:grid-cols-2
        md:grid-rows-[auto_1fr] md:max-h-[calc(100dvh-var(--navbar-height,90px))] md:min-h-0
        md:box-border lg:gap-10 lg:grid-rows-2
        lg:max-h-[calc(100dvh-var(--navbar-height,90px))] lg:min-h-0 lg:box-border;
    }

    .feature-card-1 {
      /* mobile */
      --at-apply: grid-area-[1/1/2/2];

      /* md: pleine largeur en haut */
      --at-apply: md:grid-area-[1/1/2/3];

      /* lg+: en haut à gauche */
      --at-apply: lg:grid-area-[1/1/2/2];
    }

    .feature-card-2 {
      /* mobile */
      --at-apply: grid-area-[2/1/3/2];

      /* md: bas gauche */
      --at-apply: md:grid-area-[2/1/3/2];

      /* lg+: bas gauche */
      --at-apply: lg:grid-area-[2/1/3/2];
    }

    .feature-card-3 {
      /* mobile */
      --at-apply: grid-area-[3/1/4/2];

      /* md: bas droite */
      --at-apply: md:grid-area-[2/2/3/3];

      /* lg+: span 2 rows à droite */
      --at-apply: lg:grid-area-[1/2/3/3];
    }

    .feature-card-1,
    .feature-card-2,
    .feature-card-3 {
      --at-apply: flex flex-col overflow-hidden;
    }

    .feature-card-1 {
      --at-apply: justify-center items-start;
    }

    .feature-card-2,
    .feature-card-3 {
      --at-apply: relative;
    }

    .feature-image {
      --at-apply: h-full w-full object-cover transition-transform duration-500;
    }

    .feature-card-2:hover .feature-image,
    .feature-card-3:hover .feature-image {
      --at-apply: scale-105;
    }

    .feature-image-placeholder {
      --at-apply: flex h-full min-h-48 items-center justify-center rounded-lg bg-muted
        text-mutedForeground;
    }

    .heading-home {
      white-space: pre-line;
      @media (768px <= width <= 1023px) {
        white-space: normal;
      }
      /*--at-apply: whitespace-normal lg:whitespace-pre-line;*/
    }
  </style>
</section>
